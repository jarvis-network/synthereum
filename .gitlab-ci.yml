image: registry.gitlab.com/jarvis-network/base/container-images/docker-buildx:20.10
services:
  - name: docker:20.10-dind
    entrypoint: ['env', '-u', 'DOCKER_HOST']
    command: ['dockerd-entrypoint.sh']
variables:
  DOCKER_DRIVER: overlay2
  TAG: mr-${CI_MERGE_REQUEST_ID}
  REGISTRY: jarvisnetworkcoreacr.azurecr.io/jarvis-network/apps/exchange/mono-repo
  REGISTRY_USERNAME: asim_jarvis
  REGISTRY_PASSWORD: ${GITLAB_TOKEN}
before_script:
  - docker context create buildx-ctx
  - docker buildx create buildx-ctx --use
  - echo $ACR_CORE_PASSWORD | docker login -u $ACR_CORE_USER --password-stdin $ACR_CORE_URL

.yarn-hash: &yarn-hash |-
  export YARN_LOCK_SHA256="$(sha256sum yarn.lock | cut -f1 -d' ')"
  export IMAGE="${REGISTRY}/install:${YARN_LOCK_SHA256}"

stages:
  - prepare
  - test and deploy

build `install` image:
  stage: prepare
  only:
    - merge_requests
  variables:
    TARGET: install
  script:
    - *yarn-hash
    - ./scripts/generate-pipeline.sh > generated-pipeline.yml
    - docker buildx bake ${TARGET} --print
    - docker buildx bake ${TARGET} --progress=plain
  artifacts:
    paths:
      - generated-pipeline.yml

execute pipeline:
  stage: test and deploy
  rules:
    - if: $CI_MERGE_REQUEST_ID
  trigger:
    strategy: depend
    include:
      - artifact: generated-pipeline.yml
        job: build `install` image

security scan:
  stage: test and deploy
  only:
    - merge_requests
  script:
    - *yarn-hash
    - docker pull "$IMAGE"
    - docker run --rm -v/var/run/docker.sock:/var/run/docker.sock
      aquasec/trivy --severity CRITICAL --timeout 5m "$IMAGE"
