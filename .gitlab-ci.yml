stages:
  - build
  - deploy

image: 'node:lts-alpine'

.only-default: &only-default
  only:
    - merge_requests
    - dev
    - production

build:
  <<: *only-default
  stage: build
  before_script:
    - apk add git python3 make g++
  variables:
    CI: 'false'
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules
  script:
    - yarn install
    - yarn build
  artifacts:
    paths:
      - packages/client/build

.deploy-default: &deploy-default
  stage: deploy
  needs:
    - job: build
      artifacts: true
  before_script:
    - yarn global add netlify-cli

deploy-preview-to-netlify:
  <<: *deploy-default
  only:
    - merge_requests
    - dev
  script:
    - netlify deploy --dir ./packages/client/build

deploy-production-to-netlify:
  <<: *deploy-default
  only:
    - production
  script:
    - netlify deploy --prod --dir ./packages/client/build
